{"config":{"lang":["es"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"ComfyMind - Documentaci\u00f3n T\u00e9cnica","text":"<p>Bienvenido a la documentaci\u00f3n t\u00e9cnica de ComfyMind, una aplicaci\u00f3n de art terapia que integra inteligencia artificial generativa.</p>"},{"location":"#descripcion","title":"Descripci\u00f3n","text":"<p>ComfyMind es una aplicaci\u00f3n web que combina Vue.js (frontend) y FastAPI (backend) para proporcionar sesiones de art terapia asistidas por IA, permitiendo a usuarios generar y manipular im\u00e1genes usando Stable Diffusion XL mediante ComfyUI.</p>"},{"location":"#stack-tecnologico","title":"Stack Tecnol\u00f3gico","text":""},{"location":"#backend","title":"Backend","text":"<ul> <li>Framework: FastAPI</li> <li>ORM: SQLAlchemy</li> <li>Autenticaci\u00f3n: JWT</li> <li>Base de datos: SQLite (desarrollo) / PostgreSQL (producci\u00f3n)</li> <li>IA: ComfyUI (Stable Diffusion XL)</li> </ul>"},{"location":"#frontend","title":"Frontend","text":"<ul> <li>Framework: Vue.js 3</li> <li>Build Tool: Vite</li> <li>UI: Shadcn/ui + TailwindCSS</li> <li>HTTP: Axios</li> <li>Estado: Pinia</li> </ul>"},{"location":"#navegacion","title":"Navegaci\u00f3n","text":"<ul> <li>Backend: Modelos, esquemas, operaciones CRUD y endpoints API</li> <li>Frontend: Servicios HTTP, componentes Vue y vistas principales</li> </ul>"},{"location":"#enlaces","title":"Enlaces","text":"<ul> <li>Repositorio: GitHub</li> <li>Memoria del proyecto: [Documento Word]</li> </ul> <p>Generado autom\u00e1ticamente desde docstrings del c\u00f3digo fuente</p>"},{"location":"backend/crud/","title":"CRUD Operations","text":"<p>Documentaci\u00f3n autom\u00e1tica de operaciones de base de datos.</p>"},{"location":"backend/crud/#user-crud","title":"User CRUD","text":""},{"location":"backend/crud/#app.crud.user","title":"<code>user</code>","text":"<p>Operaciones CRUD para el modelo User (Patient y Therapist).</p> <p>Funciones para crear, leer y autenticar usuarios. Incluye validaci\u00f3n de contrase\u00f1as y generaci\u00f3n de tokens JWT.</p>"},{"location":"backend/crud/#app.crud.user.get_user","title":"<code>get_user(db, user_id)</code>","text":"<p>Obtiene un usuario por ID.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario.</p> required <p>Returns:</p> Type Description <p>models.User: Usuario encontrado (Patient o Therapist).</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si el usuario no existe.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def get_user(db: Session, user_id: int):\n    \"\"\"Obtiene un usuario por ID.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario.\n\n    Returns:\n        models.User: Usuario encontrado (Patient o Therapist).\n\n    Raises:\n        HTTPException: 404 si el usuario no existe.\n    \"\"\"\n    user = db.query(models.User).filter(models.User.id == user_id).first()\n    if not user:\n        raise HTTPException(status_code=404, detail=\"Usuario no encontrado\")\n    return user\n</code></pre>"},{"location":"backend/crud/#app.crud.user.get_user_by_email","title":"<code>get_user_by_email(db, email)</code>","text":"<p>Busca un usuario por email.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>email</code> <code>str</code> <p>Email del usuario.</p> required <p>Returns:</p> Type Description <p>models.User | None: Usuario si existe, None en caso contrario.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def get_user_by_email(db: Session, email: str):\n    \"\"\"Busca un usuario por email.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        email (str): Email del usuario.\n\n    Returns:\n        models.User | None: Usuario si existe, None en caso contrario.\n    \"\"\"\n    return db.query(models.User).filter(models.User.email == email).first()\n</code></pre>"},{"location":"backend/crud/#app.crud.user.get_users","title":"<code>get_users(db)</code>","text":"<p>Obtiene todos los usuarios.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <p>Returns:</p> Type Description <p>List[models.User]: Lista de todos los usuarios.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def get_users(db: Session):\n    \"\"\"Obtiene todos los usuarios.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n\n    Returns:\n        List[models.User]: Lista de todos los usuarios.\n    \"\"\"\n    return db.query(models.User).all()\n</code></pre>"},{"location":"backend/crud/#app.crud.user.create_user","title":"<code>create_user(db, user)</code>","text":"<p>Crea un nuevo usuario (Patient o Therapist).</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user</code> <code>UserCreate</code> <p>Datos del usuario a crear.</p> required <p>Returns:</p> Type Description <p>models.User: Usuario creado (Patient o Therapist).</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>400 si tipo inv\u00e1lido, email duplicado o contrase\u00f1a d\u00e9bil.</p> <code>HTTPException</code> <p>500 si error en la creaci\u00f3n.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def create_user(db: Session, user: schemas.UserCreate):\n    \"\"\"Crea un nuevo usuario (Patient o Therapist).\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user (schemas.UserCreate): Datos del usuario a crear.\n\n    Returns:\n        models.User: Usuario creado (Patient o Therapist).\n\n    Raises:\n        HTTPException: 400 si tipo inv\u00e1lido, email duplicado o contrase\u00f1a d\u00e9bil.\n        HTTPException: 500 si error en la creaci\u00f3n.\n    \"\"\"\n    if not hasattr(user, 'type') or user.type not in (schemas.UserType.patient, schemas.UserType.therapist):\n        raise HTTPException(status_code=400, detail=\"Tipo de usuario inv\u00e1lido o faltante; debe ser 'patient' o 'therapist'\")\n\n    # Validar que el email no est\u00e9 ya registrado\n    existing_user = get_user_by_email(db, user.email)\n    if existing_user:\n        raise HTTPException(status_code=400, detail=\"El correo ya est\u00e1 registrado\")\n\n    validate_password_strength(user.password)\n    hashed_password = hash_password(user.password)\n\n    try:\n        if user.type == schemas.UserType.patient:\n            db_user = models.Patient(email=user.email, full_name=user.full_name, hashed_password=hashed_password)\n        else:\n            db_user = models.Therapist(email=user.email, full_name=user.full_name, hashed_password=hashed_password)\n\n        db.add(db_user)\n        db.commit()\n        db.refresh(db_user)\n        return db_user\n    except Exception as e:\n        db.rollback()\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Error creating user: {str(e)}\"\n        )\n</code></pre>"},{"location":"backend/crud/#app.crud.user.authenticate_user","title":"<code>authenticate_user(db, email, password)</code>","text":"<p>Autentica un usuario verificando email y contrase\u00f1a.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>email</code> <code>str</code> <p>Email del usuario.</p> required <code>password</code> <code>str</code> <p>Contrase\u00f1a en texto plano.</p> required <p>Returns:</p> Type Description <p>models.User | None: Usuario si las credenciales son v\u00e1lidas, None en caso contrario.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def authenticate_user(db: Session, email: str, password: str):\n    \"\"\"Autentica un usuario verificando email y contrase\u00f1a.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        email (str): Email del usuario.\n        password (str): Contrase\u00f1a en texto plano.\n\n    Returns:\n        models.User | None: Usuario si las credenciales son v\u00e1lidas, None en caso contrario.\n    \"\"\"\n    user = get_user_by_email(db, email)\n    if not user:\n        return None\n    if not verify_password(password, user.hashed_password):\n        return None\n    return user\n</code></pre>"},{"location":"backend/crud/#app.crud.user.login_user","title":"<code>login_user(db, email, password)</code>","text":"<p>Realiza login de usuario y genera token JWT.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>email</code> <code>str</code> <p>Email del usuario.</p> required <code>password</code> <code>str</code> <p>Contrase\u00f1a en texto plano.</p> required <p>Returns:</p> Name Type Description <code>dict</code> <p>Token de acceso. - access_token (str): Token JWT. - token_type (str): Tipo de token (\"bearer\").</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>401 si las credenciales son incorrectas.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def login_user(db: Session, email: str, password: str):\n    \"\"\"Realiza login de usuario y genera token JWT.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        email (str): Email del usuario.\n        password (str): Contrase\u00f1a en texto plano.\n\n    Returns:\n        dict: Token de acceso.\n            - access_token (str): Token JWT.\n            - token_type (str): Tipo de token (\"bearer\").\n\n    Raises:\n        HTTPException: 401 si las credenciales son incorrectas.\n    \"\"\"\n    user = authenticate_user(db, email, password)\n    if not user:\n        raise HTTPException(status_code=401, detail=\"El correo o la contrase\u00f1a son incorrectos\")\n\n    access_token = create_access_token({\"sub\": str(user.id),  \"user_type\": user.type})\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n</code></pre>"},{"location":"backend/crud/#app.crud.user.validate_password_strength","title":"<code>validate_password_strength(password)</code>","text":"<p>Valida que una contrase\u00f1a cumpla los requisitos de seguridad.</p> <p>Requisitos: - Al menos 8 caracteres - Al menos una letra may\u00fascula - Al menos un d\u00edgito - Al menos un car\u00e1cter especial</p> <p>Parameters:</p> Name Type Description Default <code>password</code> <code>str</code> <p>Contrase\u00f1a a validar.</p> required <p>Raises:</p> Type Description <code>HTTPException</code> <p>400 si la contrase\u00f1a no cumple los requisitos.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def validate_password_strength(password: str):\n    \"\"\"Valida que una contrase\u00f1a cumpla los requisitos de seguridad.\n\n    Requisitos:\n    - Al menos 8 caracteres\n    - Al menos una letra may\u00fascula\n    - Al menos un d\u00edgito\n    - Al menos un car\u00e1cter especial\n\n    Args:\n        password (str): Contrase\u00f1a a validar.\n\n    Raises:\n        HTTPException: 400 si la contrase\u00f1a no cumple los requisitos.\n    \"\"\"\n    if len(password) &lt; 8:\n        raise HTTPException(status_code=400, detail=\"La contrase\u00f1a debe tener al menos 8 caracteres.\")\n    if not re.search(r\"[A-Z]\", password):\n        raise HTTPException(status_code=400, detail=\"La contrase\u00f1a debe contener al menos una letra may\u00fascula.\")\n    if not re.search(r\"\\d\", password):\n        raise HTTPException(status_code=400, detail=\"La contrase\u00f1a debe contener al menos un d\u00edgito.\")\n    if not re.search(r\"[!@#$%^&amp;*(),.?\\\":{}&lt;&gt;|]\", password):\n        raise HTTPException(status_code=400, detail=\"La contrase\u00f1a debe contener al menos un car\u00e1cter especial.\")\n</code></pre>"},{"location":"backend/crud/#app.crud.user.get_images_for_user_no_session","title":"<code>get_images_for_user_no_session(db, user_id)</code>","text":"<p>Obtiene todas las im\u00e1genes de un usuario sin sesi\u00f3n asociada.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario.</p> required <p>Returns:</p> Name Type Description <code>dict</code> <p>Im\u00e1genes sin session_id.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si el usuario no existe.</p> Source code in <code>backend\\app\\crud\\user.py</code> <pre><code>def get_images_for_user_no_session(db: Session, user_id: int):\n    \"\"\"Obtiene todas las im\u00e1genes de un usuario sin sesi\u00f3n asociada.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario.\n\n    Returns:\n        dict: Im\u00e1genes sin session_id.\n\n    Raises:\n        HTTPException: 404 si el usuario no existe.\n    \"\"\"\n    db_user = db.query(models.User).filter(models.User.id == user_id).first()\n    if not db_user:\n        raise HTTPException(status_code=404, detail=\"Usuario no encontrado\")\n\n    images = db.query(models.Image).filter(models.Image.owner_id == user_id).filter(models.Image.session_id == None).all()\n    return {\n        \"data\": images,\n        \"count\": len(images)\n    }\n</code></pre>"},{"location":"backend/crud/#session-crud","title":"Session CRUD","text":""},{"location":"backend/crud/#app.crud.session","title":"<code>session</code>","text":""},{"location":"backend/crud/#app.crud.session.finalize_expired_sessions","title":"<code>finalize_expired_sessions(db, user_id=None)</code>","text":"<p>Auto-finalize sessions that passed their scheduled end_date without being ended.</p> <p>If user_id is provided, scope to sessions where the user is patient or therapist to minimize the update set for per-request calls.</p> Source code in <code>backend\\app\\crud\\session.py</code> <pre><code>def finalize_expired_sessions(db: Session, user_id: int | None = None):\n    \"\"\"Auto-finalize sessions that passed their scheduled end_date without being ended.\n\n    If user_id is provided, scope to sessions where the user is patient or therapist\n    to minimize the update set for per-request calls.\n    \"\"\"\n    query = db.query(models.Session).filter(\n            models.Session.ended_at == None,\n            models.Session.end_date != None,\n            models.Session.end_date &lt;= datetime.utcnow()\n    )\n\n    if user_id is not None:\n        query = query.filter(\n            (models.Session.patient_id == user_id) | (models.Session.therapist_id == user_id)\n        )\n\n    to_close = query.all()\n    if not to_close:\n        return 0\n\n    for session in to_close:\n        session.ended_at = session.end_date\n\n    db.commit()\n    return len(to_close)\n</code></pre>"},{"location":"backend/crud/#app.crud.session.end_session","title":"<code>end_session(db, session_id)</code>","text":"<p>Mark a session as ended by setting <code>ended_at</code> to now.</p> Source code in <code>backend\\app\\crud\\session.py</code> <pre><code>def end_session(db: Session, session_id: int):\n    \"\"\"\n    Mark a session as ended by setting `ended_at` to now.\n    \"\"\"\n    db_session = db.query(models.Session).filter(models.Session.id == session_id).first()\n    if not db_session:\n        raise HTTPException(status_code=404, detail=\"Sesi\u00f3n no encontrada\")\n    if db_session.ended_at is not None:\n        raise HTTPException(status_code=400, detail=\"La sesi\u00f3n ya ha finalizado\")\n    db_session.ended_at = datetime.utcnow()\n    db.commit()\n    db.refresh(db_session)\n    return db_session\n</code></pre>"},{"location":"backend/crud/#app.crud.session.get_images_for_session","title":"<code>get_images_for_session(db, session_id)</code>","text":"<p>Retrieve all images for a given session.</p> Source code in <code>backend\\app\\crud\\session.py</code> <pre><code>def get_images_for_session(db: Session, session_id: int):\n    \"\"\"Retrieve all images for a given session.\"\"\"\n    db_session = db.query(models.Session).filter(models.Session.id == session_id).first()\n    if not db_session:\n        raise HTTPException(status_code=404, detail=\"Sesi\u00f3n no encontrada\")\n    images = db.query(models.Image).filter(models.Image.session_id == session_id).all()\n    return {\n        \"data\": images,\n        \"count\": len(images)\n    }\n</code></pre>"},{"location":"backend/crud/#comfyui-crud","title":"ComfyUI CRUD","text":""},{"location":"backend/crud/#app.crud.comfy","title":"<code>comfy</code>","text":""},{"location":"backend/crud/#app.crud.comfy.create_user_uploaded_image","title":"<code>create_user_uploaded_image(db, upload_file, user_id, isDrawn=False)</code>","text":"<p>Save an uploaded file to the generated_images folder and create DB record.</p> Source code in <code>backend\\app\\crud\\comfy.py</code> <pre><code>def create_user_uploaded_image(db: Session, upload_file, user_id: int, isDrawn: bool = False):\n    \"\"\"Save an uploaded file to the generated_images folder and create DB record.\"\"\"\n    db_user = db.query(models.User).filter(models.User.id == user_id).first()\n    if not db_user or db_user.type != 'patient':\n        raise HTTPException(status_code=404, detail=\"Los terapeutas no pueden tener im\u00e1genes o usuario no encontrado\")\n\n    try:\n        image = services.image_generation.publicar_imagen(upload_file, isDrawn=isDrawn)\n\n        # create DB record\n        db_image = models.Image(fileName=image[\"file\"], seed = image[\"seed\"], owner_id=user_id)\n        db.add(db_image)\n        db.commit()\n        db.refresh(db_image)\n\n        return image\n    except HTTPException:\n        raise\n    except Exception as e:\n        db.rollback()\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Error al subir imagen: {str(e)}\"\n        )\n</code></pre>"},{"location":"backend/crud/#app.crud.comfy.create_user_drawn_image","title":"<code>create_user_drawn_image(db, upload_file, user_id)</code>","text":"<p>Save a drawn image to drawn_images and create DB record.</p> Source code in <code>backend\\app\\crud\\comfy.py</code> <pre><code>def create_user_drawn_image(db: Session, upload_file, user_id: int):\n    \"\"\"Save a drawn image to drawn_images and create DB record.\"\"\"\n    db_user = db.query(models.User).filter(models.User.id == user_id).first()\n    if not db_user or db_user.type != 'patient':\n        raise HTTPException(status_code=404, detail=\"Los terapeutas no pueden tener im\u00e1genes o usuario no encontrado\")\n\n    try:\n        image = services.image_generation.publicar_dibujo(upload_file)\n\n        db_image = models.Image(fileName=image[\"file\"], seed = image.get(\"seed\"), owner_id=user_id)\n        db.add(db_image)\n        db.commit()\n        db.refresh(db_image)\n\n        return image\n    except HTTPException:\n        raise\n    except Exception as e:\n        db.rollback()\n        raise HTTPException(\n            status_code=500,\n            detail=f\"Error al guardar imagen dibujada: {str(e)}\"\n        )\n</code></pre>"},{"location":"backend/crud/#app.crud.comfy.get_template_images","title":"<code>get_template_images()</code>","text":"<p>Retrieve all template images from the template directory.</p> Source code in <code>backend\\app\\crud\\comfy.py</code> <pre><code>def get_template_images():\n    \"\"\"Retrieve all template images from the template directory.\"\"\"\n    return services.image_generation.obtener_imagenes_plantilla()\n</code></pre>"},{"location":"backend/crud/#app.crud.comfy.get_images_for_user","title":"<code>get_images_for_user(db, user_id)</code>","text":"<p>Retrieve all images for a given user.</p> Source code in <code>backend\\app\\crud\\comfy.py</code> <pre><code>def get_images_for_user(db: Session, user_id: int):\n    \"\"\"Retrieve all images for a given user.\"\"\"\n    db_user = db.query(models.User).filter(models.User.id == user_id).first()\n    if not db_user:\n        raise HTTPException(status_code=404, detail=\"Usuario no encontrado\")\n\n    images = db.query(models.Image).filter(models.Image.owner_id == user_id).all()\n    return {\n        \"data\": images,\n        \"count\": len(images)\n    }\n</code></pre>"},{"location":"backend/crud/#app.crud.comfy.link_image_to_session","title":"<code>link_image_to_session(db, image_file_name, user_id, session_id)</code>","text":"<p>Crea un registro de imagen asociado a una sesi\u00f3n sin duplicar el archivo.</p> Source code in <code>backend\\app\\crud\\comfy.py</code> <pre><code>def link_image_to_session(db: Session, image_file_name: str, user_id: int, session_id: int):\n    \"\"\"Crea un registro de imagen asociado a una sesi\u00f3n sin duplicar el archivo.\"\"\"\n    # Validar usuario\n    db_user = db.query(models.User).filter(models.User.id == user_id).first()\n    if not db_user or db_user.type != 'patient':\n        raise HTTPException(status_code=404, detail=\"Usuario no encontrado o no es paciente\")\n\n    # Validar sesi\u00f3n\n    db_session = db.query(models.Session).filter(models.Session.id == session_id).first()\n    if not db_session:\n        raise HTTPException(status_code=404, detail=\"Sesi\u00f3n no encontrada\")\n    if db_session.patient_id != user_id:\n        raise HTTPException(status_code=403, detail=\"El usuario no es paciente de esta sesi\u00f3n\")\n    if db_session.ended_at is not None:\n        raise HTTPException(status_code=400, detail=\"No se pueden agregar im\u00e1genes a una sesi\u00f3n finalizada\")\n\n    # Buscar o crear registro de imagen\n    db_image = db.query(models.Image).filter(models.Image.fileName == image_file_name, models.Image.owner_id == user_id).first()\n\n    if not db_image:\n        # Si no existe registro, crear uno nuevo\n        try:\n            new_image = models.Image(\n                fileName=image_file_name,\n                seed=None,  # No tenemos seed si la imagen no fue generada por nosotros\n                owner_id=user_id,\n                session_id=session_id\n            )\n            db.add(new_image)\n            db.commit()\n            db.refresh(new_image)\n\n            # Construir path de la imagen\n            image_path = f\"generated/{image_file_name}\" if not image_file_name.startswith(\"drawn_\") else f\"drawn/{image_file_name}\"\n\n            return {\n                \"message\": \"Imagen asociada a la sesi\u00f3n correctamente\",\n                \"file\": image_file_name,\n                \"fullPath\": image_path,\n                \"seed\": None\n            }\n        except Exception as e:\n            db.rollback()\n            raise HTTPException(\n                status_code=500,\n                detail=f\"Error al crear registro de imagen: {str(e)}\"\n            )\n    else:\n        # Si ya existe, solo asociarlo a la sesi\u00f3n\n        try:\n            new_image = models.Image(\n                fileName=image_file_name,\n                seed=db_image.seed,\n                owner_id=user_id,\n                session_id=session_id\n            )\n            db.add(new_image)\n            db.commit()\n            db.refresh(new_image)\n\n            # Construir path de la imagen\n            image_path = f\"generated/{image_file_name}\" if not image_file_name.startswith(\"drawn_\") else f\"drawn/{image_file_name}\"\n\n            return {\n                \"message\": \"Imagen asociada a la sesi\u00f3n correctamente\",\n                \"file\": image_file_name,\n                \"fullPath\": image_path,\n                \"seed\": db_image.seed\n            }\n        except Exception as e:\n            db.rollback()\n            raise HTTPException(\n                status_code=500,\n                detail=f\"Error al asociar imagen a la sesi\u00f3n: {str(e)}\"\n            )\n</code></pre>"},{"location":"backend/endpoints/","title":"API Endpoints","text":"<p>Referencia autom\u00e1tica de endpoints REST.</p>"},{"location":"backend/endpoints/#users-api","title":"Users API","text":""},{"location":"backend/endpoints/#app.api.users","title":"<code>users</code>","text":"<p>Router de API para gesti\u00f3n de usuarios.</p> <p>Endpoints para autenticaci\u00f3n, registro y gesti\u00f3n de usuarios. Incluye operaciones CRUD de usuarios e im\u00e1genes sin sesi\u00f3n asociada.</p>"},{"location":"backend/endpoints/#app.api.users.read_users","title":"<code>read_users(db)</code>  <code>async</code>","text":"<p>Obtiene lista de todos los usuarios.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <p>Returns:</p> Type Description <p>List[schemas.User]: Lista de todos los usuarios registrados.</p> Source code in <code>backend\\app\\api\\users.py</code> <pre><code>@router.get(\"/users/\", response_model=List[schemas.User])\nasync def read_users(db: SessionDep):\n    \"\"\"Obtiene lista de todos los usuarios.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n\n    Returns:\n        List[schemas.User]: Lista de todos los usuarios registrados.\n    \"\"\"\n    users = crud.user.get_users(db)\n    return users\n</code></pre>"},{"location":"backend/endpoints/#app.api.users.read_user_me","title":"<code>read_user_me(db, current_user)</code>","text":"<p>Obtiene informaci\u00f3n del usuario actual autenticado.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado desde token JWT.</p> required <p>Returns:</p> Type Description <p>schemas.User: Informaci\u00f3n del usuario actual.</p> Source code in <code>backend\\app\\api\\users.py</code> <pre><code>@router.get(\"/users/me\", response_model=schemas.User)\ndef read_user_me(db: SessionDep, current_user: CurrentUser):\n    \"\"\"Obtiene informaci\u00f3n del usuario actual autenticado.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado desde token JWT.\n\n    Returns:\n        schemas.User: Informaci\u00f3n del usuario actual.\n    \"\"\"\n    return current_user\n</code></pre>"},{"location":"backend/endpoints/#app.api.users.read_user","title":"<code>read_user(db, user_id, current_user)</code>  <code>async</code>","text":"<p>Obtiene informaci\u00f3n de un usuario por ID.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario a consultar.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.User: Informaci\u00f3n del usuario solicitado.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si el usuario no existe.</p> Source code in <code>backend\\app\\api\\users.py</code> <pre><code>@router.get(\"/users/{user_id}\", response_model=schemas.User)\nasync def read_user(db: SessionDep, user_id: int, current_user: CurrentUser):\n    \"\"\"Obtiene informaci\u00f3n de un usuario por ID.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario a consultar.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.User: Informaci\u00f3n del usuario solicitado.\n\n    Raises:\n        HTTPException: 404 si el usuario no existe.\n    \"\"\"\n    db_user = crud.user.get_user(db, user_id=user_id)\n    if db_user is None:\n        raise HTTPException(status_code=404, detail=\"Usuario no encontrado\")\n    return db_user\n</code></pre>"},{"location":"backend/endpoints/#app.api.users.create_user","title":"<code>create_user(db, user)</code>  <code>async</code>","text":"<p>Registra un nuevo usuario en el sistema.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user</code> <code>UserCreate</code> <p>Datos del usuario a crear.</p> required <p>Returns:</p> Type Description <p>schemas.User: Usuario creado.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>400 si el email ya est\u00e1 registrado.</p> Source code in <code>backend\\app\\api\\users.py</code> <pre><code>@router.post(\"/users/\", response_model=schemas.User)\nasync def create_user(db: SessionDep, user: schemas.UserCreate):\n    \"\"\"Registra un nuevo usuario en el sistema.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user (schemas.UserCreate): Datos del usuario a crear.\n\n    Returns:\n        schemas.User: Usuario creado.\n\n    Raises:\n        HTTPException: 400 si el email ya est\u00e1 registrado.\n    \"\"\"\n    db_user = crud.user.get_user_by_email(db, email=user.email)\n    if db_user:\n        raise HTTPException(status_code=400, detail=\"El correo ya est\u00e1 registrado\")\n    return crud.user.create_user(db=db, user=user)\n</code></pre>"},{"location":"backend/endpoints/#app.api.users.login_access_token","title":"<code>login_access_token(db, form_data)</code>  <code>async</code>","text":"<p>OAuth2 compatible token login.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>form_data</code> <code>OAuth2PasswordRequestForm</code> <p>Credenciales (username=email, password).</p> required <p>Returns:</p> Name Type Description <code>dict</code> <p>Token de acceso JWT y tipo de token. - access_token (str): Token JWT. - token_type (str): Tipo de token (bearer).</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>401 si las credenciales son inv\u00e1lidas.</p> Source code in <code>backend\\app\\api\\users.py</code> <pre><code>@router.post(\"/login/\")\nasync def login_access_token(db: SessionDep, form_data: Annotated[OAuth2PasswordRequestForm, Depends()]):\n    \"\"\"OAuth2 compatible token login.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        form_data (OAuth2PasswordRequestForm): Credenciales (username=email, password).\n\n    Returns:\n        dict: Token de acceso JWT y tipo de token.\n            - access_token (str): Token JWT.\n            - token_type (str): Tipo de token (bearer).\n\n    Raises:\n        HTTPException: 401 si las credenciales son inv\u00e1lidas.\n    \"\"\"\n    return crud.user.login_user(db=db, email=form_data.username, password=form_data.password)\n</code></pre>"},{"location":"backend/endpoints/#app.api.users.get_images_for_user_no_session","title":"<code>get_images_for_user_no_session(db, user_id, current_user)</code>  <code>async</code>","text":"<p>Obtiene im\u00e1genes del usuario sin sesi\u00f3n asociada.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.ImagesOut: Im\u00e1genes del usuario sin session_id.</p> Source code in <code>backend\\app\\api\\users.py</code> <pre><code>@router.get('/users/{user_id}/free-images', response_model=schemas.ImagesOut)\nasync def get_images_for_user_no_session(db: SessionDep, user_id: int, current_user: CurrentUser):\n    \"\"\"Obtiene im\u00e1genes del usuario sin sesi\u00f3n asociada.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.ImagesOut: Im\u00e1genes del usuario sin session_id.\n    \"\"\"\n    return crud.user.get_images_for_user_no_session(db=db, user_id=user_id)\n</code></pre>"},{"location":"backend/endpoints/#sessions-api","title":"Sessions API","text":""},{"location":"backend/endpoints/#app.api.sessions","title":"<code>sessions</code>","text":"<p>Router de API para gesti\u00f3n de sesiones de terapia.</p> <p>Endpoints para crear, actualizar, consultar y finalizar sesiones entre terapeutas y pacientes. Incluye gesti\u00f3n de sesiones activas, pr\u00f3ximas y finalizadas.</p>"},{"location":"backend/endpoints/#app.api.sessions.create_session","title":"<code>create_session(db, patient_id, therapist_id, session, current_user)</code>","text":"<p>Crea una sesi\u00f3n entre un paciente y un terapeuta (endpoint gen\u00e9rico).</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>patient_id</code> <code>int</code> <p>ID del paciente.</p> required <code>therapist_id</code> <code>int</code> <p>ID del terapeuta.</p> required <code>session</code> <code>SessionCreate</code> <p>Datos de la sesi\u00f3n (fechas).</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.Session: Sesi\u00f3n creada.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.post(\"/session/{patient_id}/{therapist_id}\", response_model=schemas.Session)\ndef create_session(db: SessionDep, patient_id: int, therapist_id: int, session: schemas.SessionCreate, current_user: CurrentUser):\n    \"\"\"Crea una sesi\u00f3n entre un paciente y un terapeuta (endpoint gen\u00e9rico).\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        patient_id (int): ID del paciente.\n        therapist_id (int): ID del terapeuta.\n        session (schemas.SessionCreate): Datos de la sesi\u00f3n (fechas).\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.Session: Sesi\u00f3n creada.\n    \"\"\"\n    return crud.session.create_session_for_users(db=db, patient_id=patient_id, therapist_id=therapist_id, session=session)\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.create_session_for_patient","title":"<code>create_session_for_patient(patient_id, db, current_user, session)</code>","text":"<p>Crea una sesi\u00f3n para un paciente (solo terapeutas).</p> <p>Parameters:</p> Name Type Description Default <code>patient_id</code> <code>int</code> <p>ID del paciente.</p> required <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado (debe ser terapeuta).</p> required <code>session</code> <code>SessionCreate</code> <p>Datos de la sesi\u00f3n.</p> required <p>Returns:</p> Type Description <p>schemas.Session: Sesi\u00f3n creada.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>403 si el usuario no es terapeuta.</p> <code>HTTPException</code> <p>404 si el paciente no existe.</p> <code>HTTPException</code> <p>400 si las fechas son inv\u00e1lidas.</p> Note <p>Env\u00eda notificaci\u00f3n WebSocket al paciente si est\u00e1 conectado.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.post(\"/session/{patient_id}\", response_model=schemas.Session)\ndef create_session_for_patient(patient_id: int, \n                               db: SessionDep, \n                               current_user: CurrentUser,\n                               session: schemas.SessionCreate):\n    \"\"\"Crea una sesi\u00f3n para un paciente (solo terapeutas).\n\n    Args:\n        patient_id (int): ID del paciente.\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado (debe ser terapeuta).\n        session (schemas.SessionCreate): Datos de la sesi\u00f3n.\n\n    Returns:\n        schemas.Session: Sesi\u00f3n creada.\n\n    Raises:\n        HTTPException: 403 si el usuario no es terapeuta.\n        HTTPException: 404 si el paciente no existe.\n        HTTPException: 400 si las fechas son inv\u00e1lidas.\n\n    Note:\n        Env\u00eda notificaci\u00f3n WebSocket al paciente si est\u00e1 conectado.\n    \"\"\"\n    if current_user.type != 'therapist':\n        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN,\n                            detail=\"Solo los terapeutas pueden crear sesiones\")\n    patient = db.query(models.Patient).filter(models.Patient.id == patient_id).first()\n    if not patient:\n        raise HTTPException(status_code=404, detail=\"Paciente no encontrado\")\n    if session.start_date &gt;= session.end_date:\n        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST,\n                            detail=\"La fecha de inicio debe ser anterior a la fecha de fin\")\n\n    new_session = crud.session.create_session_for_users(db=db, patient_id=patient.id, therapist_id=current_user.id, session=session)\n\n    notify_new_session_to_patient(patient_id, new_session.id)\n\n    return new_session\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.update_session","title":"<code>update_session(session_id, session, db, current_user)</code>","text":"<p>Actualiza una sesi\u00f3n existente.</p> <p>Parameters:</p> Name Type Description Default <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n a actualizar.</p> required <code>session</code> <code>SessionUpdate</code> <p>Nuevos datos de la sesi\u00f3n.</p> required <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.Session: Sesi\u00f3n actualizada.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.put(\"/session/{session_id}\", response_model=schemas.Session)\ndef update_session(session_id: int, session: schemas.SessionUpdate, db: SessionDep, current_user: CurrentUser):\n    \"\"\"Actualiza una sesi\u00f3n existente.\n\n    Args:\n        session_id (int): ID de la sesi\u00f3n a actualizar.\n        session (schemas.SessionUpdate): Nuevos datos de la sesi\u00f3n.\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.Session: Sesi\u00f3n actualizada.\n    \"\"\"\n    return crud.session.update_session(db, session_id, session, current_user.id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.get_sessions_active_user","title":"<code>get_sessions_active_user(db, current_user)</code>  <code>async</code>","text":"<p>Obtiene todas las sesiones del usuario actual (como paciente o terapeuta).</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.SessionsOut: Lista de sesiones del usuario con contador.</p> Note <p>Finaliza autom\u00e1ticamente sesiones expiradas antes de retornar.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.get('/my-sessions', response_model=schemas.SessionsOut)\nasync def get_sessions_active_user(db: SessionDep, current_user: CurrentUser):\n    \"\"\"Obtiene todas las sesiones del usuario actual (como paciente o terapeuta).\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.SessionsOut: Lista de sesiones del usuario con contador.\n\n    Note:\n        Finaliza autom\u00e1ticamente sesiones expiradas antes de retornar.\n    \"\"\"\n    crud.session.finalize_expired_sessions(db, current_user.id)\n    sessions = db.query(models.Session).filter(\n        (models.Session.patient_id == current_user.id) | (models.Session.therapist_id == current_user.id)\n    ).all()\n    return {\"data\": sessions, \"count\": len(sessions)}\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.get_active_session","title":"<code>get_active_session(db, current_user)</code>","text":"<p>Obtiene la sesi\u00f3n activa del usuario actual.</p> <p>Una sesi\u00f3n es activa si: now entre start_date y end_date, y ended_at es None.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.Session: Sesi\u00f3n activa del usuario.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si no hay sesi\u00f3n activa.</p> Note <p>Busca primero como paciente, luego como terapeuta. Si el terapeuta tiene m\u00faltiples sesiones activas, devuelve la m\u00e1s antigua.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.get('/active', response_model=schemas.Session)\ndef get_active_session(db: SessionDep, current_user: CurrentUser):\n    \"\"\"Obtiene la sesi\u00f3n activa del usuario actual.\n\n    Una sesi\u00f3n es activa si: now entre start_date y end_date, y ended_at es None.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.Session: Sesi\u00f3n activa del usuario.\n\n    Raises:\n        HTTPException: 404 si no hay sesi\u00f3n activa.\n\n    Note:\n        Busca primero como paciente, luego como terapeuta.\n        Si el terapeuta tiene m\u00faltiples sesiones activas, devuelve la m\u00e1s antigua.\n    \"\"\"\n    now = datetime.utcnow()\n    crud.session.finalize_expired_sessions(db, current_user.id)\n    # First try as patient\n\n    S2 = aliased(models.Session)\n    session = db.query(models.Session).filter(\n        models.Session.patient_id == current_user.id,\n        models.Session.start_date &lt;= now,\n        models.Session.end_date &gt;= now,\n        models.Session.ended_at == None,\n        ~exists().where(and_(\n            S2.therapist_id == models.Session.therapist_id,\n            S2.start_date &lt;= now,\n            S2.end_date &gt;= now,\n            S2.ended_at == None,\n            S2.start_date &lt; models.Session.start_date\n        ))\n    ).order_by(models.Session.start_date.asc()).first()\n    if session:\n        return session\n\n    # Then try as therapist\n    session = db.query(models.Session).filter(\n        models.Session.therapist_id == current_user.id,\n        models.Session.start_date &lt;= now,\n        models.Session.end_date &gt;= now,\n        models.Session.ended_at == None,\n    ).order_by(models.Session.start_date.asc()).first()\n    if session:\n        return session\n\n    # Not found\n    raise HTTPException(status_code=404, detail=\"No hay sesi\u00f3n activa\")\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.get_next_session","title":"<code>get_next_session(db, current_user)</code>","text":"<p>Obtiene la pr\u00f3xima sesi\u00f3n del usuario (activa o futura).</p> <p>L\u00f3gica: 1. Si hay sesi\u00f3n activa (start &lt;= now &lt;= end, no finalizada): retorna esa. 2. Si no hay activa: retorna la pr\u00f3xima sesi\u00f3n futura ordenada por start_date. 3. Si no hay ninguna: error 404.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.Session: Pr\u00f3xima sesi\u00f3n (activa o futura).</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si no hay sesiones programadas.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.get('/next', response_model=schemas.Session)\ndef get_next_session(db: SessionDep, current_user: CurrentUser):\n    \"\"\"Obtiene la pr\u00f3xima sesi\u00f3n del usuario (activa o futura).\n\n    L\u00f3gica:\n    1. Si hay sesi\u00f3n activa (start &lt;= now &lt;= end, no finalizada): retorna esa.\n    2. Si no hay activa: retorna la pr\u00f3xima sesi\u00f3n futura ordenada por start_date.\n    3. Si no hay ninguna: error 404.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.Session: Pr\u00f3xima sesi\u00f3n (activa o futura).\n\n    Raises:\n        HTTPException: 404 si no hay sesiones programadas.\n    \"\"\"\n    now = datetime.utcnow()\n    crud.session.finalize_expired_sessions(db, current_user.id)\n\n    base_query = db.query(models.Session).filter(\n        ((models.Session.patient_id == current_user.id) | (models.Session.therapist_id == current_user.id)),\n        models.Session.ended_at == None,\n    )\n\n    # Primero, la activa\n    active = base_query.filter(\n        models.Session.start_date &lt;= now,\n        models.Session.end_date &gt;= now,\n    ).first()\n    if active:\n        return active\n\n    # Luego, la pr\u00f3xima futura ordenada por fecha de inicio\n    upcoming = base_query.filter(models.Session.start_date &gt; now).order_by(models.Session.start_date.asc()).first()\n    if upcoming:\n        return upcoming\n\n    raise HTTPException(status_code=404, detail=\"No tienes ninguna sesi\u00f3n programada\")\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.get_session_by_id","title":"<code>get_session_by_id(session_id, db, current_user)</code>","text":"<p>Obtiene informaci\u00f3n de una sesi\u00f3n por ID.</p> <p>Parameters:</p> Name Type Description Default <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n.</p> required <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.Session: Informaci\u00f3n de la sesi\u00f3n.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si la sesi\u00f3n no existe.</p> <code>HTTPException</code> <p>403 si el usuario no es participante (paciente o terapeuta).</p> Note <p>Retorna la sesi\u00f3n incluso si ha sido finalizada (ended_at establecido).</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.get('/session/{session_id}', response_model=schemas.Session)\ndef get_session_by_id(session_id: int, db: SessionDep, current_user: CurrentUser):\n    \"\"\"Obtiene informaci\u00f3n de una sesi\u00f3n por ID.\n\n    Args:\n        session_id (int): ID de la sesi\u00f3n.\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.Session: Informaci\u00f3n de la sesi\u00f3n.\n\n    Raises:\n        HTTPException: 404 si la sesi\u00f3n no existe.\n        HTTPException: 403 si el usuario no es participante (paciente o terapeuta).\n\n    Note:\n        Retorna la sesi\u00f3n incluso si ha sido finalizada (ended_at establecido).\n    \"\"\"\n    crud.session.finalize_expired_sessions(db, current_user.id)\n    session = db.query(models.Session).filter(models.Session.id == session_id).first()\n    if not session:\n        raise HTTPException(status_code=404, detail=\"Sesi\u00f3n no encontrada\")\n\n    if current_user.id not in (session.patient_id, session.therapist_id):\n        raise HTTPException(status_code=403, detail=\"No tienes permiso para ver esta sesi\u00f3n\")\n\n    return session\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.end_session_by_id","title":"<code>end_session_by_id(session_id, db, current_user)</code>  <code>async</code>","text":"<p>Finaliza una sesi\u00f3n (solo terapeuta).</p> <p>Establece ended_at al momento actual y notifica a clientes WebSocket conectados.</p> <p>Parameters:</p> Name Type Description Default <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n a finalizar.</p> required <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado (debe ser terapeuta de la sesi\u00f3n).</p> required <p>Returns:</p> Type Description <p>schemas.Session: Sesi\u00f3n finalizada.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>404 si la sesi\u00f3n no existe.</p> <code>HTTPException</code> <p>403 si el usuario no es el terapeuta de la sesi\u00f3n.</p> Note <p>Intenta cerrar conexiones WebSocket activas para esta sesi\u00f3n.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.post('/end/{session_id}', response_model=schemas.Session)\nasync def end_session_by_id(session_id: int, db: SessionDep, current_user: CurrentUser):\n    \"\"\"Finaliza una sesi\u00f3n (solo terapeuta).\n\n    Establece ended_at al momento actual y notifica a clientes WebSocket conectados.\n\n    Args:\n        session_id (int): ID de la sesi\u00f3n a finalizar.\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado (debe ser terapeuta de la sesi\u00f3n).\n\n    Returns:\n        schemas.Session: Sesi\u00f3n finalizada.\n\n    Raises:\n        HTTPException: 404 si la sesi\u00f3n no existe.\n        HTTPException: 403 si el usuario no es el terapeuta de la sesi\u00f3n.\n\n    Note:\n        Intenta cerrar conexiones WebSocket activas para esta sesi\u00f3n.\n    \"\"\"\n    session = db.query(models.Session).filter(models.Session.id == session_id).first()\n    if not session:\n        raise HTTPException(status_code=404, detail=\"Sesi\u00f3n no encontrada\")\n    if current_user.type != 'therapist' or current_user.id != session.therapist_id:\n        raise HTTPException(status_code=403, detail=\"Solo el terapeuta de esta sesi\u00f3n puede finalizarla\")\n\n    updated = crud.session.end_session(db, session_id)\n\n    try:\n        import app.api.ws as ws_module\n        conns = ws_module.active_sessions.get(session_id, {})\n        for role, ws in list(conns.items()):\n            try:\n                await ws.send_text('session_ended')\n            except Exception:\n                pass\n            try:\n                await ws.close(code=1000)\n            except Exception:\n                pass\n    except Exception:\n        pass\n\n    return updated\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.delete_session_by_id","title":"<code>delete_session_by_id(session_id, db, current_user)</code>  <code>async</code>","text":"<p>Elimina una sesi\u00f3n (solo terapeuta).</p> <p>Parameters:</p> Name Type Description Default <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n a eliminar.</p> required <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado (debe ser terapeuta).</p> required <p>Returns:</p> Name Type Description <code>dict</code> <p>Mensaje de confirmaci\u00f3n de eliminaci\u00f3n.</p> <p>Raises:</p> Type Description <code>HTTPException</code> <p>403 si el usuario no es terapeuta.</p> <code>HTTPException</code> <p>404 si la sesi\u00f3n no existe.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.delete('/session/{session_id}')\nasync def delete_session_by_id(session_id: int, db: SessionDep, current_user: CurrentUser):\n    \"\"\"Elimina una sesi\u00f3n (solo terapeuta).\n\n    Args:\n        session_id (int): ID de la sesi\u00f3n a eliminar.\n        db (Session): Sesi\u00f3n de base de datos.\n        current_user (CurrentUser): Usuario autenticado (debe ser terapeuta).\n\n    Returns:\n        dict: Mensaje de confirmaci\u00f3n de eliminaci\u00f3n.\n\n    Raises:\n        HTTPException: 403 si el usuario no es terapeuta.\n        HTTPException: 404 si la sesi\u00f3n no existe.\n    \"\"\"\n    return crud.session.delete_session(db, session_id, current_user.id, current_user.type)\n</code></pre>"},{"location":"backend/endpoints/#app.api.sessions.get_images_for_session","title":"<code>get_images_for_session(db, session_id, current_user)</code>  <code>async</code>","text":"<p>Obtiene todas las im\u00e1genes generadas durante una sesi\u00f3n.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.ImagesOut: Lista de im\u00e1genes de la sesi\u00f3n.</p> Source code in <code>backend\\app\\api\\sessions.py</code> <pre><code>@router.get('/sessions/{session_id}/images', response_model=schemas.ImagesOut)\nasync def get_images_for_session(db: SessionDep, session_id: int, current_user: CurrentUser):\n    \"\"\"Obtiene todas las im\u00e1genes generadas durante una sesi\u00f3n.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        session_id (int): ID de la sesi\u00f3n.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.ImagesOut: Lista de im\u00e1genes de la sesi\u00f3n.\n    \"\"\"\n    return crud.session.get_images_for_session(db=db, session_id=session_id)\n</code></pre>"},{"location":"backend/endpoints/#comfyui-api","title":"ComfyUI API","text":""},{"location":"backend/endpoints/#app.api.comfy","title":"<code>comfy</code>","text":"<p>Router de API para generaci\u00f3n de im\u00e1genes con ComfyUI.</p> <p>Endpoints para generar im\u00e1genes usando Stable Diffusion XL a trav\u00e9s de ComfyUI. Soporta diferentes workflows: txt2img, img2img, sketch2img, y combinaciones de m\u00faltiples im\u00e1genes.</p>"},{"location":"backend/endpoints/#app.api.comfy.link_image_to_session","title":"<code>link_image_to_session(db, user_id, current_user, image_file_name=Query(...), session_id=Query(...))</code>  <code>async</code>","text":"<p>Asocia una imagen existente a una sesi\u00f3n sin duplicar el archivo.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario propietario de la imagen.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <code>image_file_name</code> <code>str</code> <p>Nombre del archivo de imagen existente.</p> <code>Query(...)</code> <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n a la que asociar la imagen.</p> <code>Query(...)</code> <p>Returns:</p> Type Description <p>schemas.ImageGenerationResponse: Respuesta con informaci\u00f3n de la imagen vinculada.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.post(\"/users/{user_id}/session-images/link\", response_model=schemas.ImageGenerationResponse)\nasync def link_image_to_session(db: SessionDep, user_id: int, current_user: CurrentUser, image_file_name: str = Query(...), session_id: int = Query(...)):\n    \"\"\"Asocia una imagen existente a una sesi\u00f3n sin duplicar el archivo.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario propietario de la imagen.\n        current_user (CurrentUser): Usuario autenticado.\n        image_file_name (str): Nombre del archivo de imagen existente.\n        session_id (int): ID de la sesi\u00f3n a la que asociar la imagen.\n\n    Returns:\n        schemas.ImageGenerationResponse: Respuesta con informaci\u00f3n de la imagen vinculada.\n    \"\"\"\n    return crud.comfy.link_image_to_session(db=db, image_file_name=image_file_name, user_id=user_id, session_id=session_id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.generate_image_for_user","title":"<code>generate_image_for_user(db, user_id, prompt, current_user, session_id=None)</code>  <code>async</code>","text":"<p>Genera imagen usando ComfyUI workflow txt2img.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario para el que se genera la imagen.</p> required <code>prompt</code> <code>Prompt</code> <p>Prompt de texto y par\u00e1metros de generaci\u00f3n.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <code>session_id</code> <code>int</code> <p>ID de sesi\u00f3n asociada. Default None.</p> <code>None</code> <p>Returns:</p> Type Description <p>schemas.ImageGenerationResponse: Imagen generada con metadata.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.post(\"/users/{user_id}/images\", response_model=schemas.ImageGenerationResponse)\nasync def generate_image_for_user(db: SessionDep, user_id: int, prompt: schemas.Prompt, current_user: CurrentUser, session_id: int | None = None):\n    \"\"\"Genera imagen usando ComfyUI workflow txt2img.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario para el que se genera la imagen.\n        prompt (schemas.Prompt): Prompt de texto y par\u00e1metros de generaci\u00f3n.\n        current_user (CurrentUser): Usuario autenticado.\n        session_id (int, optional): ID de sesi\u00f3n asociada. Default None.\n\n    Returns:\n        schemas.ImageGenerationResponse: Imagen generada con metadata.\n    \"\"\"\n    db_user = crud.user.get_user(db, user_id=user_id)\n    return crud.comfy.create_user_image(db=db, prompt=prompt, user_id=user_id, session_id=session_id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.generate_sketch_image_for_user","title":"<code>generate_sketch_image_for_user(db, user_id, prompt, current_user, session_id=None)</code>  <code>async</code>","text":"<p>Genera imagen usando ComfyUI workflow sketch2img o img2img.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario para el que se genera la imagen.</p> required <code>prompt</code> <code>SketchPrompt</code> <p>Prompt con imagen base y par\u00e1metros.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <code>session_id</code> <code>int</code> <p>ID de sesi\u00f3n asociada. Default None.</p> <code>None</code> <p>Returns:</p> Type Description <p>schemas.ImageGenerationResponse: Imagen generada con metadata.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.post(\"/users/{user_id}/sketch-images/\", response_model=schemas.ImageGenerationResponse)\nasync def generate_sketch_image_for_user(db: SessionDep, user_id: int, prompt: schemas.SketchPrompt, current_user: CurrentUser, session_id: int | None = None):\n    \"\"\"Genera imagen usando ComfyUI workflow sketch2img o img2img.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario para el que se genera la imagen.\n        prompt (schemas.SketchPrompt): Prompt con imagen base y par\u00e1metros.\n        current_user (CurrentUser): Usuario autenticado.\n        session_id (int, optional): ID de sesi\u00f3n asociada. Default None.\n\n    Returns:\n        schemas.ImageGenerationResponse: Imagen generada con metadata.\n    \"\"\"\n    db_user = crud.user.get_user(db, user_id=user_id)\n    return crud.comfy.create_user_sketch_image(db=db, prompt=prompt, user_id=user_id, session_id=session_id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.generate_image_for_user_multiple","title":"<code>generate_image_for_user_multiple(db, user_id, images, current_user, session_id=None)</code>  <code>async</code>","text":"<p>Genera imagen combinando m\u00faltiples im\u00e1genes (2, 3 o 4).</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario para el que se genera la imagen.</p> required <code>images</code> <code>TemplateImagesIn</code> <p>Lista de im\u00e1genes y par\u00e1metros.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <code>session_id</code> <code>int</code> <p>ID de sesi\u00f3n asociada. Default None.</p> <code>None</code> <p>Returns:</p> Type Description <p>schemas.ImageGenerationResponse: Imagen generada combinando las fuentes.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.post(\"/users/{user_id}/multiple-images/\", response_model=schemas.ImageGenerationResponse)\nasync def generate_image_for_user_multiple(db: SessionDep, user_id: int, images: schemas.TemplateImagesIn, current_user: CurrentUser, session_id: int | None = None):\n    \"\"\"Genera imagen combinando m\u00faltiples im\u00e1genes (2, 3 o 4).\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario para el que se genera la imagen.\n        images (schemas.TemplateImagesIn): Lista de im\u00e1genes y par\u00e1metros.\n        current_user (CurrentUser): Usuario autenticado.\n        session_id (int, optional): ID de sesi\u00f3n asociada. Default None.\n\n    Returns:\n        schemas.ImageGenerationResponse: Imagen generada combinando las fuentes.\n    \"\"\"\n    db_user = crud.user.get_user(db, user_id=user_id)\n    return crud.comfy.create_user_img_by_mult_images(db=db, images=images, user_id=user_id, session_id=session_id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.upload_image_for_user","title":"<code>upload_image_for_user(db, user_id, current_user, file=File(...), isDrawn=False)</code>  <code>async</code>","text":"<p>Sube una imagen desde el cliente al servidor.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario propietario.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <code>file</code> <code>UploadFile</code> <p>Archivo de imagen a subir.</p> <code>File(...)</code> <code>isDrawn</code> <code>bool</code> <p>Si es un dibujo creado en canvas. Default False.</p> <code>False</code> <p>Returns:</p> Type Description <p>schemas.ImageGenerationResponse: Informaci\u00f3n de la imagen subida.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.post('/users/{user_id}/images/upload', response_model=schemas.ImageGenerationResponse)\nasync def upload_image_for_user(db: SessionDep, user_id: int, current_user: CurrentUser, file: UploadFile = File(...), isDrawn: bool = False):\n    \"\"\"Sube una imagen desde el cliente al servidor.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario propietario.\n        current_user (CurrentUser): Usuario autenticado.\n        file (UploadFile): Archivo de imagen a subir.\n        isDrawn (bool): Si es un dibujo creado en canvas. Default False.\n\n    Returns:\n        schemas.ImageGenerationResponse: Informaci\u00f3n de la imagen subida.\n    \"\"\"\n    return crud.comfy.create_user_uploaded_image(db=db, upload_file=file, user_id=user_id, isDrawn=isDrawn)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.upload_drawn_image_for_user","title":"<code>upload_drawn_image_for_user(db, user_id, current_user, file=File(...))</code>  <code>async</code>","text":"<p>Guarda un dibujo creado en canvas.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario propietario.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <code>file</code> <code>UploadFile</code> <p>Archivo del dibujo.</p> <code>File(...)</code> <p>Returns:</p> Type Description <p>schemas.ImageGenerationResponse: Informaci\u00f3n del dibujo guardado.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.post('/users/{user_id}/images/drawn', response_model=schemas.ImageGenerationResponse)\nasync def upload_drawn_image_for_user(db: SessionDep, user_id: int, current_user: CurrentUser, file: UploadFile = File(...)):\n    \"\"\"Guarda un dibujo creado en canvas.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario propietario.\n        current_user (CurrentUser): Usuario autenticado.\n        file (UploadFile): Archivo del dibujo.\n\n    Returns:\n        schemas.ImageGenerationResponse: Informaci\u00f3n del dibujo guardado.\n    \"\"\"\n    return crud.comfy.create_user_drawn_image(db=db, upload_file=file, user_id=user_id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.get_images_for_user","title":"<code>get_images_for_user(db, user_id, current_user)</code>  <code>async</code>","text":"<p>Obtiene todas las im\u00e1genes de un usuario.</p> <p>Parameters:</p> Name Type Description Default <code>db</code> <code>Session</code> <p>Sesi\u00f3n de base de datos.</p> required <code>user_id</code> <code>int</code> <p>ID del usuario.</p> required <code>current_user</code> <code>CurrentUser</code> <p>Usuario autenticado.</p> required <p>Returns:</p> Type Description <p>schemas.ImagesOut: Lista de im\u00e1genes del usuario.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.get('/users/{user_id}/images', response_model=schemas.ImagesOut)\nasync def get_images_for_user(db: SessionDep, user_id: int, current_user: CurrentUser):\n    \"\"\"Obtiene todas las im\u00e1genes de un usuario.\n\n    Args:\n        db (Session): Sesi\u00f3n de base de datos.\n        user_id (int): ID del usuario.\n        current_user (CurrentUser): Usuario autenticado.\n\n    Returns:\n        schemas.ImagesOut: Lista de im\u00e1genes del usuario.\n    \"\"\"\n    return crud.comfy.get_images_for_user(db=db, user_id=user_id)\n</code></pre>"},{"location":"backend/endpoints/#app.api.comfy.get_template_images","title":"<code>get_template_images()</code>","text":"<p>Obtiene lista de im\u00e1genes plantilla disponibles.</p> <p>Returns:</p> Name Type Description <code>list</code> <p>Nombres de archivos de im\u00e1genes plantilla.</p> Source code in <code>backend\\app\\api\\comfy.py</code> <pre><code>@router.get(\"/template-images\")\ndef get_template_images():\n    \"\"\"Obtiene lista de im\u00e1genes plantilla disponibles.\n\n    Returns:\n        list: Nombres de archivos de im\u00e1genes plantilla.\n    \"\"\"\n    return crud.comfy.get_template_images()\n</code></pre>"},{"location":"backend/endpoints/#websocket-api","title":"WebSocket API","text":""},{"location":"backend/endpoints/#app.api.ws","title":"<code>ws</code>","text":"<p>Router de API para comunicaci\u00f3n WebSocket en tiempo real.</p> <p>Proporciona endpoints WebSocket para: - Comunicaci\u00f3n bidireccional durante sesiones (chat, notificaciones de im\u00e1genes) - Notificaciones en Home/Calendar (nuevas sesiones creadas)</p> <p>Attributes:</p> Name Type Description <code>active_sessions</code> <code>Dict[int, Dict[str, WebSocket]]</code> <p>Conexiones activas por sesi\u00f3n. Estructura: {session_id: {\"patient\": WebSocket, \"therapist\": WebSocket}}</p> <code>home_ws_connections</code> <code>Dict[int, WebSocket]</code> <p>Conexiones Home activas por usuario. Estructura: {user_id: WebSocket}</p>"},{"location":"backend/endpoints/#app.api.ws.websocket_endpoint","title":"<code>websocket_endpoint(websocket, session_id, role)</code>  <code>async</code>","text":"<p>WebSocket bidireccional para comunicaci\u00f3n en sesiones de terapia.</p> <p>Funcionalidades: - Chat en tiempo real entre paciente y terapeuta - Notificaciones de im\u00e1genes generadas - Notificaciones de estado de sesi\u00f3n - Finalizaci\u00f3n de sesi\u00f3n</p> <p>Parameters:</p> Name Type Description Default <code>websocket</code> <code>WebSocket</code> <p>Conexi\u00f3n WebSocket.</p> required <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n de terapia.</p> required <code>role</code> <code>str</code> <p>Rol del usuario (\"patient\" o \"therapist\").</p> required Query Parameters <p>token (str): Token JWT para autenticaci\u00f3n.</p> Protocol <ul> <li>Env\u00edo/recepci\u00f3n de JSON: {\"event\": str, \"sender\": str, \"text\": str, ...}</li> <li>Texto plano se convierte autom\u00e1ticamente a mensaje de chat</li> </ul> Note <p>La conexi\u00f3n se cierra si: - No se proporciona token - Token inv\u00e1lido - Usuario no autorizado para la sesi\u00f3n - Sesi\u00f3n ya finalizada (ended_at != None)</p> Source code in <code>backend\\app\\api\\ws.py</code> <pre><code>@router.websocket(\"/ws/{session_id}/{role}\")\nasync def websocket_endpoint(websocket: WebSocket, session_id: int, role: str):\n    \"\"\"WebSocket bidireccional para comunicaci\u00f3n en sesiones de terapia.\n\n    Funcionalidades:\n    - Chat en tiempo real entre paciente y terapeuta\n    - Notificaciones de im\u00e1genes generadas\n    - Notificaciones de estado de sesi\u00f3n\n    - Finalizaci\u00f3n de sesi\u00f3n\n\n    Args:\n        websocket (WebSocket): Conexi\u00f3n WebSocket.\n        session_id (int): ID de la sesi\u00f3n de terapia.\n        role (str): Rol del usuario (\"patient\" o \"therapist\").\n\n    Query Parameters:\n        token (str): Token JWT para autenticaci\u00f3n.\n\n    Protocol:\n        - Env\u00edo/recepci\u00f3n de JSON: {\"event\": str, \"sender\": str, \"text\": str, ...}\n        - Texto plano se convierte autom\u00e1ticamente a mensaje de chat\n\n    Note:\n        La conexi\u00f3n se cierra si:\n        - No se proporciona token\n        - Token inv\u00e1lido\n        - Usuario no autorizado para la sesi\u00f3n\n        - Sesi\u00f3n ya finalizada (ended_at != None)\n    \"\"\"\n\n    # 1. Obtener token del query param\n    token = websocket.query_params.get(\"token\")\n    if not token:\n        await websocket.close(code=1008)\n        return\n\n    # 2. Decodificar JWT\n    try:\n        user_id = int(decode_access_token(token))\n    except Exception:\n        await websocket.close(code=1008)\n        return\n\n    # 3. Verificar sesi\u00f3n y rol en la base de datos\n    db = SessionLocal()\n    try:\n        user = db.query(models.User).filter(models.User.id == user_id).first()\n        session = db.query(models.Session).filter(models.Session.id == session_id).first()\n\n        if not user or not session:\n            await websocket.close(code=1008)\n            return\n\n        # Si la sesi\u00f3n est\u00e1 finalizada, cerrar el WebSocket\n        if getattr(session, \"ended_at\", None) is not None:\n            await websocket.close(code=1008)\n            return\n\n        # Verificar rol\n        if role == \"patient\" and user.id != session.patient_id:\n            await websocket.close(code=1008)\n            return\n        if role == \"therapist\" and user.id != session.therapist_id:\n            await websocket.close(code=1008)\n            return\n\n    finally:\n        db.close()\n\n    # 4. Aceptar conexi\u00f3n\n    await websocket.accept()\n\n    # Registrar socket\n    if session_id not in active_sessions:\n        active_sessions[session_id] = {}\n    active_sessions[session_id][role] = websocket\n\n    print(f\"{role} conectado en sesi\u00f3n {session_id} (user {user_id})\")\n\n    # Informar\n\n    try:\n        while True:\n            data = await websocket.receive_text()\n            other_role = \"therapist\" if role == \"patient\" else \"patient\"\n\n            try:\n                obj = json.loads(data)\n            except json.JSONDecodeError:\n                # Texto plano \u2192 convertir a mensaje de chat\n                obj = {\"event\": \"chat_message\", \"sender\": role, \"text\": data}\n\n            # Si el otro est\u00e1 conectado, enviar mensaje\n            if other_role in active_sessions.get(session_id, {}):\n                try:\n                    await active_sessions[session_id][other_role].send_text(json.dumps(obj))\n                except Exception:\n                    del active_sessions[session_id][other_role]\n\n    except WebSocketDisconnect:\n        print(f\"{role} desconectado de la sesi\u00f3n {session_id}\")\n        if session_id in active_sessions and role in active_sessions[session_id]:\n            del active_sessions[session_id][role]\n        if session_id in active_sessions and not active_sessions[session_id]:\n            del active_sessions[session_id]\n</code></pre>"},{"location":"backend/endpoints/#app.api.ws.websocket_home","title":"<code>websocket_home(websocket)</code>  <code>async</code>","text":"<p>WebSocket para notificaciones en vista Home/Calendar.</p> <p>Permite notificar a pacientes cuando un terapeuta crea una sesi\u00f3n para ellos.</p> <p>Parameters:</p> Name Type Description Default <code>websocket</code> <code>WebSocket</code> <p>Conexi\u00f3n WebSocket.</p> required Query Parameters <p>token (str): Token JWT para autenticaci\u00f3n.</p> Protocol <ul> <li>Server \u2192 Client: {\"event\": \"new_session\", \"sessionId\": int}</li> <li>Client \u2192 Server: Heartbeat (cualquier texto para mantener conexi\u00f3n)</li> </ul> Note <p>La conexi\u00f3n se cierra si no se proporciona token o es inv\u00e1lido.</p> Source code in <code>backend\\app\\api\\ws.py</code> <pre><code>@router.websocket(\"/ws/home\")\nasync def websocket_home(websocket: WebSocket):\n    \"\"\"WebSocket para notificaciones en vista Home/Calendar.\n\n    Permite notificar a pacientes cuando un terapeuta crea una sesi\u00f3n para ellos.\n\n    Args:\n        websocket (WebSocket): Conexi\u00f3n WebSocket.\n\n    Query Parameters:\n        token (str): Token JWT para autenticaci\u00f3n.\n\n    Protocol:\n        - Server \u2192 Client: {\"event\": \"new_session\", \"sessionId\": int}\n        - Client \u2192 Server: Heartbeat (cualquier texto para mantener conexi\u00f3n)\n\n    Note:\n        La conexi\u00f3n se cierra si no se proporciona token o es inv\u00e1lido.\n    \"\"\"\n\n    # Obtener token del query param\n    token = websocket.query_params.get(\"token\")\n    if not token:\n        await websocket.close(code=1008)\n        return\n\n    # Decodificar JWT\n    try:\n        user_id = int(decode_access_token(token))\n    except Exception:\n        await websocket.close(code=1008)\n        return\n\n    # Aceptar conexi\u00f3n\n    await websocket.accept()\n\n    # Registrar conexi\u00f3n\n    home_ws_connections[user_id] = websocket\n    print(f\"Usuario {user_id} conectado a Home WS\")\n\n    try:\n        # Mantener conexi\u00f3n viva (heartbeat simple)\n        while True:\n            await websocket.receive_text()\n    except WebSocketDisconnect:\n        print(f\"Usuario {user_id} desconectado de Home WS\")\n        home_ws_connections.pop(user_id, None)\n    except Exception as e:\n        print(f\"Error en Home WS para usuario {user_id}: {e}\")\n        home_ws_connections.pop(user_id, None)\n</code></pre>"},{"location":"backend/endpoints/#app.api.ws.notify_new_session_to_patient","title":"<code>notify_new_session_to_patient(patient_id, session_id)</code>","text":"<p>Notifica a un paciente conectado sobre una nueva sesi\u00f3n creada.</p> <p>Env\u00eda notificaci\u00f3n WebSocket al paciente si est\u00e1 conectado a /ws/home. Llamado autom\u00e1ticamente cuando un terapeuta crea una sesi\u00f3n.</p> <p>Parameters:</p> Name Type Description Default <code>patient_id</code> <code>int</code> <p>ID del paciente a notificar.</p> required <code>session_id</code> <code>int</code> <p>ID de la nueva sesi\u00f3n creada.</p> required Note <p>Si el paciente no est\u00e1 conectado, la notificaci\u00f3n se descarta silenciosamente. Utiliza asyncio.create_task para env\u00edo as\u00edncrono sin bloquear.</p> Source code in <code>backend\\app\\api\\ws.py</code> <pre><code>def notify_new_session_to_patient(patient_id: int, session_id: int):\n    \"\"\"Notifica a un paciente conectado sobre una nueva sesi\u00f3n creada.\n\n    Env\u00eda notificaci\u00f3n WebSocket al paciente si est\u00e1 conectado a /ws/home.\n    Llamado autom\u00e1ticamente cuando un terapeuta crea una sesi\u00f3n.\n\n    Args:\n        patient_id (int): ID del paciente a notificar.\n        session_id (int): ID de la nueva sesi\u00f3n creada.\n\n    Note:\n        Si el paciente no est\u00e1 conectado, la notificaci\u00f3n se descarta silenciosamente.\n        Utiliza asyncio.create_task para env\u00edo as\u00edncrono sin bloquear.\n    \"\"\"\n    if patient_id not in home_ws_connections:\n        print(f\"Paciente {patient_id} no est\u00e1 conectado a Home WS\")\n        return\n\n    async def send_notification():\n        try:\n            websocket = home_ws_connections.get(patient_id)\n            if websocket:\n                await websocket.send_text(json.dumps({\n                    \"event\": \"new_session\",\n                    \"sessionId\": session_id\n                }))\n                print(f\"\u2705 Notificaci\u00f3n enviada al paciente {patient_id} para sesi\u00f3n {session_id}\")\n        except Exception as e:\n            print(f\"\u274c Error notificando al paciente {patient_id}: {e}\")\n            home_ws_connections.pop(patient_id, None)\n\n    # Crear una tarea en el event loop actual\n    try:\n        asyncio.create_task(send_notification())\n    except RuntimeError as e:\n        print(f\"Error creando tarea async: {e}\")\n        # Fallback: intentar con asyncio.run() (menos ideal pero funciona)\n        try:\n            asyncio.run(send_notification())\n        except Exception as e2:\n            print(f\"Error en fallback: {e2}\")\n</code></pre>"},{"location":"backend/models/","title":"Modelos ORM (SQLAlchemy)","text":"<p>Documentaci\u00f3n autom\u00e1tica de modelos de base de datos.</p>"},{"location":"backend/models/#user-base","title":"User (Base)","text":""},{"location":"backend/models/#app.models.User","title":"<code>User</code>","text":"<p>               Bases: <code>Base</code></p> <p>Modelo base de usuario con herencia de tabla \u00fanica (STI).</p> <p>Representa un usuario gen\u00e9rico en el sistema. Utiliza herencia de tabla \u00fanica (Single Table Inheritance) para soportar diferentes tipos de usuarios (pacientes y terapeutas) en la misma tabla de base de datos.</p> <p>Attributes:</p> Name Type Description <code>id</code> <code>int</code> <p>Identificador \u00fanico del usuario.</p> <code>email</code> <code>str</code> <p>Correo electr\u00f3nico \u00fanico del usuario. Indexado para b\u00fasquedas r\u00e1pidas.</p> <code>full_name</code> <code>str</code> <p>Nombre completo del usuario.</p> <code>hashed_password</code> <code>str</code> <p>Contrase\u00f1a hasheada del usuario. Nunca se almacena en texto plano.</p> <code>is_active</code> <code>bool</code> <p>Indica si la cuenta del usuario est\u00e1 activa. Por defecto True.</p> <code>created_at</code> <code>datetime</code> <p>Fecha y hora de creaci\u00f3n del usuario. Se asigna autom\u00e1ticamente.</p> <code>type</code> <code>str</code> <p>Discriminador para herencia. Valores: 'user', 'patient', 'therapist'.</p> Note <p>Esta clase utiliza el patr\u00f3n Single Table Inheritance (STI) de SQLAlchemy. Las subclases Patient y Therapist heredan de esta clase base.</p> Source code in <code>backend\\app\\models.py</code> <pre><code>class User(Base):\n    \"\"\"Modelo base de usuario con herencia de tabla \u00fanica (STI).\n\n    Representa un usuario gen\u00e9rico en el sistema. Utiliza herencia de tabla \u00fanica\n    (Single Table Inheritance) para soportar diferentes tipos de usuarios (pacientes\n    y terapeutas) en la misma tabla de base de datos.\n\n    Attributes:\n        id (int): Identificador \u00fanico del usuario.\n        email (str): Correo electr\u00f3nico \u00fanico del usuario. Indexado para b\u00fasquedas r\u00e1pidas.\n        full_name (str): Nombre completo del usuario.\n        hashed_password (str): Contrase\u00f1a hasheada del usuario. Nunca se almacena en texto plano.\n        is_active (bool): Indica si la cuenta del usuario est\u00e1 activa. Por defecto True.\n        created_at (datetime): Fecha y hora de creaci\u00f3n del usuario. Se asigna autom\u00e1ticamente.\n        type (str): Discriminador para herencia. Valores: 'user', 'patient', 'therapist'.\n\n    Note:\n        Esta clase utiliza el patr\u00f3n Single Table Inheritance (STI) de SQLAlchemy.\n        Las subclases Patient y Therapist heredan de esta clase base.\n    \"\"\"\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True, index=True)\n    email = Column(String, unique=True, index=True, nullable=False)\n    full_name = Column(String, nullable=False)\n    hashed_password = Column(String, nullable=False)\n    is_active = Column(Boolean, default=True)\n    created_at = Column(DateTime(timezone=True), server_default=func.now())\n\n    # discriminator column for single-table inheritance\n    type = Column(String(50), nullable=False, server_default='user')\n\n    __mapper_args__ = {\n        'polymorphic_on': type,\n        'polymorphic_identity': 'user'\n    }\n</code></pre>"},{"location":"backend/models/#patient","title":"Patient","text":""},{"location":"backend/models/#app.models.Patient","title":"<code>Patient</code>","text":"<p>               Bases: <code>User</code></p> <p>Subtipo de usuario que representa a un paciente.</p> <p>Extiende el modelo User para representar pacientes que reciben terapia. Los pacientes pueden generar im\u00e1genes durante las sesiones de terapia.</p> <p>Attributes:</p> Name Type Description <code>images</code> <code>List[Image]</code> <p>Lista de im\u00e1genes generadas por el paciente. Relaci\u00f3n uno-a-muchos con el modelo Image.</p> Note <p>Hereda todos los atributos de User. El discriminador 'type' se establece autom\u00e1ticamente como 'patient'.</p> Source code in <code>backend\\app\\models.py</code> <pre><code>class Patient(User):\n    \"\"\"Subtipo de usuario que representa a un paciente.\n\n    Extiende el modelo User para representar pacientes que reciben terapia.\n    Los pacientes pueden generar im\u00e1genes durante las sesiones de terapia.\n\n    Attributes:\n        images (List[Image]): Lista de im\u00e1genes generadas por el paciente.\n            Relaci\u00f3n uno-a-muchos con el modelo Image.\n\n    Note:\n        Hereda todos los atributos de User. El discriminador 'type' se establece\n        autom\u00e1ticamente como 'patient'.\n    \"\"\"\n\n    images = relationship(\"Image\", back_populates=\"owner\")  # One user can have many images\n\n    __mapper_args__ = {\n        'polymorphic_identity': 'patient'\n    }\n</code></pre>"},{"location":"backend/models/#therapist","title":"Therapist","text":""},{"location":"backend/models/#app.models.Therapist","title":"<code>Therapist</code>","text":"<p>               Bases: <code>User</code></p> <p>Subtipo de usuario que representa a un terapeuta.</p> <p>Extiende el modelo User para representar terapeutas que conducen sesiones con pacientes. Los terapeutas pueden crear, gestionar y finalizar sesiones.</p> Note <p>Hereda todos los atributos de User. El discriminador 'type' se establece autom\u00e1ticamente como 'therapist'.</p> Source code in <code>backend\\app\\models.py</code> <pre><code>class Therapist(User):\n    \"\"\"Subtipo de usuario que representa a un terapeuta.\n\n    Extiende el modelo User para representar terapeutas que conducen sesiones\n    con pacientes. Los terapeutas pueden crear, gestionar y finalizar sesiones.\n\n    Note:\n        Hereda todos los atributos de User. El discriminador 'type' se establece\n        autom\u00e1ticamente como 'therapist'.\n    \"\"\"\n\n    __mapper_args__ = {\n        'polymorphic_identity': 'therapist'\n    }\n</code></pre>"},{"location":"backend/models/#session","title":"Session","text":""},{"location":"backend/models/#app.models.Session","title":"<code>Session</code>","text":"<p>               Bases: <code>Base</code></p> <p>Modelo para sesiones de terapia entre terapeuta y paciente.</p> <p>Representa una sesi\u00f3n de arte-terapia con fechas de inicio y fin programadas. Las sesiones son creadas por terapeutas para trabajar con pacientes espec\u00edficos. Pueden contener m\u00faltiples im\u00e1genes generadas durante la sesi\u00f3n.</p> <p>Attributes:</p> Name Type Description <code>id</code> <code>int</code> <p>Identificador \u00fanico de la sesi\u00f3n.</p> <code>patient_id</code> <code>int</code> <p>ID del paciente que participa en la sesi\u00f3n. Clave for\u00e1nea que referencia users.id.</p> <code>therapist_id</code> <code>int</code> <p>ID del terapeuta que conduce la sesi\u00f3n. Clave for\u00e1nea que referencia users.id.</p> <code>created_at</code> <code>datetime</code> <p>Fecha y hora de creaci\u00f3n del registro de sesi\u00f3n. Se asigna autom\u00e1ticamente al crear la sesi\u00f3n.</p> <code>start_date</code> <code>datetime</code> <p>Fecha y hora de inicio programada de la sesi\u00f3n.</p> <code>end_date</code> <code>datetime</code> <p>Fecha y hora de fin programada de la sesi\u00f3n.</p> <code>ended_at</code> <code>datetime</code> <p>Timestamp real cuando el terapeuta finaliza la sesi\u00f3n. Es None mientras la sesi\u00f3n est\u00e1 activa.</p> <code>patient</code> <code>Patient</code> <p>Relaci\u00f3n con el paciente de la sesi\u00f3n.</p> <code>therapist</code> <code>Therapist</code> <p>Relaci\u00f3n con el terapeuta de la sesi\u00f3n.</p> <code>images</code> <code>List[Image]</code> <p>Lista de im\u00e1genes generadas durante esta sesi\u00f3n.</p> Note <p>Una sesi\u00f3n se considera activa si ended_at es None. El terapeuta puede finalizarla antes de end_date estableciendo ended_at.</p> Source code in <code>backend\\app\\models.py</code> <pre><code>class Session(Base):\n    \"\"\"Modelo para sesiones de terapia entre terapeuta y paciente.\n\n    Representa una sesi\u00f3n de arte-terapia con fechas de inicio y fin programadas.\n    Las sesiones son creadas por terapeutas para trabajar con pacientes espec\u00edficos.\n    Pueden contener m\u00faltiples im\u00e1genes generadas durante la sesi\u00f3n.\n\n    Attributes:\n        id (int): Identificador \u00fanico de la sesi\u00f3n.\n        patient_id (int): ID del paciente que participa en la sesi\u00f3n.\n            Clave for\u00e1nea que referencia users.id.\n        therapist_id (int): ID del terapeuta que conduce la sesi\u00f3n.\n            Clave for\u00e1nea que referencia users.id.\n        created_at (datetime): Fecha y hora de creaci\u00f3n del registro de sesi\u00f3n.\n            Se asigna autom\u00e1ticamente al crear la sesi\u00f3n.\n        start_date (datetime): Fecha y hora de inicio programada de la sesi\u00f3n.\n        end_date (datetime): Fecha y hora de fin programada de la sesi\u00f3n.\n        ended_at (datetime, optional): Timestamp real cuando el terapeuta finaliza la sesi\u00f3n.\n            Es None mientras la sesi\u00f3n est\u00e1 activa.\n        patient (Patient): Relaci\u00f3n con el paciente de la sesi\u00f3n.\n        therapist (Therapist): Relaci\u00f3n con el terapeuta de la sesi\u00f3n.\n        images (List[Image]): Lista de im\u00e1genes generadas durante esta sesi\u00f3n.\n\n    Note:\n        Una sesi\u00f3n se considera activa si ended_at es None. El terapeuta puede\n        finalizarla antes de end_date estableciendo ended_at.\n    \"\"\"\n    __tablename__ = \"sessions\"\n\n    id = Column(Integer, primary_key=True, index=True)\n    patient_id = Column(Integer, ForeignKey(\"users.id\"), nullable=False)\n    therapist_id = Column(Integer, ForeignKey(\"users.id\"), nullable=False)\n    created_at = Column(DateTime(timezone=True), server_default=func.now())\n    # Period during which the session is active\n    start_date = Column(DateTime(timezone=True), nullable=False)\n    end_date = Column(DateTime(timezone=True), nullable=False)\n    # Real end timestamp set when the therapist finalizes the session\n    ended_at = Column(DateTime(timezone=True), nullable=True)\n\n    patient = relationship(\"Patient\", foreign_keys=[patient_id])\n    therapist = relationship(\"Therapist\", foreign_keys=[therapist_id])\n    images = relationship(\"Image\", back_populates=\"session\")\n</code></pre>"},{"location":"backend/models/#image","title":"Image","text":""},{"location":"backend/models/#app.models.Image","title":"<code>Image</code>","text":"<p>               Bases: <code>Base</code></p> <p>Modelo para im\u00e1genes generadas durante las sesiones de terapia.</p> <p>Almacena informaci\u00f3n sobre las im\u00e1genes creadas por pacientes usando Stable Diffusion XL a trav\u00e9s de ComfyUI. Cada imagen est\u00e1 asociada a un paciente (owner) y opcionalmente a una sesi\u00f3n espec\u00edfica.</p> <p>Attributes:</p> Name Type Description <code>id</code> <code>int</code> <p>Identificador \u00fanico de la imagen.</p> <code>fileName</code> <code>str</code> <p>Nombre del archivo de imagen almacenado en el sistema.</p> <code>seed</code> <code>int</code> <p>Semilla utilizada para la generaci\u00f3n de la imagen. Permite reproducir la misma imagen con los mismos par\u00e1metros.</p> <code>owner_id</code> <code>int</code> <p>ID del paciente propietario de la imagen. Clave for\u00e1nea que referencia users.id.</p> <code>session_id</code> <code>int</code> <p>ID de la sesi\u00f3n en la que se gener\u00f3 la imagen. Clave for\u00e1nea que referencia sessions.id. Puede ser None.</p> <code>owner</code> <code>Patient</code> <p>Relaci\u00f3n con el paciente propietario de la imagen.</p> <code>session</code> <code>Session</code> <p>Relaci\u00f3n con la sesi\u00f3n en la que se gener\u00f3 la imagen.</p> Note <p>Las im\u00e1genes pueden existir sin estar asociadas a una sesi\u00f3n espec\u00edfica (session_id puede ser NULL).</p> Source code in <code>backend\\app\\models.py</code> <pre><code>class Image(Base):\n    \"\"\"Modelo para im\u00e1genes generadas durante las sesiones de terapia.\n\n    Almacena informaci\u00f3n sobre las im\u00e1genes creadas por pacientes usando\n    Stable Diffusion XL a trav\u00e9s de ComfyUI. Cada imagen est\u00e1 asociada\n    a un paciente (owner) y opcionalmente a una sesi\u00f3n espec\u00edfica.\n\n    Attributes:\n        id (int): Identificador \u00fanico de la imagen.\n        fileName (str): Nombre del archivo de imagen almacenado en el sistema.\n        seed (int, optional): Semilla utilizada para la generaci\u00f3n de la imagen.\n            Permite reproducir la misma imagen con los mismos par\u00e1metros.\n        owner_id (int): ID del paciente propietario de la imagen.\n            Clave for\u00e1nea que referencia users.id.\n        session_id (int, optional): ID de la sesi\u00f3n en la que se gener\u00f3 la imagen.\n            Clave for\u00e1nea que referencia sessions.id. Puede ser None.\n        owner (Patient): Relaci\u00f3n con el paciente propietario de la imagen.\n        session (Session): Relaci\u00f3n con la sesi\u00f3n en la que se gener\u00f3 la imagen.\n\n    Note:\n        Las im\u00e1genes pueden existir sin estar asociadas a una sesi\u00f3n espec\u00edfica\n        (session_id puede ser NULL).\n    \"\"\"\n    __tablename__ = \"images\"\n\n    id = Column(Integer, primary_key=True, index=True)\n    fileName = Column(String, nullable=False)\n    seed = Column(Integer, nullable=True)\n    owner_id = Column(Integer, ForeignKey(\"users.id\"))\n    session_id = Column(Integer, ForeignKey(\"sessions.id\"), nullable=True)\n\n    owner = relationship(\"Patient\", back_populates=\"images\") # One item belongs to one user\n    session = relationship(\"Session\", back_populates=\"images\") # One item belongs to one user\n</code></pre>"},{"location":"backend/schemas/","title":"Pydantic Schemas","text":"<p>Documentaci\u00f3n autom\u00e1tica de schemas de validaci\u00f3n.</p>"},{"location":"backend/schemas/#user-schemas","title":"User Schemas","text":""},{"location":"backend/schemas/#app.schemas.user","title":"<code>user</code>","text":"<p>Schemas Pydantic para validaci\u00f3n de datos de usuarios.</p> <p>Define los modelos de datos para: - Creaci\u00f3n de usuarios (UserCreate) - Login (UserLogin) - Respuesta de usuario (User) - Enum de tipos de usuario (UserType)</p>"},{"location":"backend/schemas/#app.schemas.user.UserType","title":"<code>UserType</code>","text":"<p>               Bases: <code>str</code>, <code>Enum</code></p> <p>Tipos de usuario en el sistema.</p> <p>Attributes:</p> Name Type Description <code>patient</code> <p>Usuario paciente que recibe terapia.</p> <code>therapist</code> <p>Usuario terapeuta que conduce sesiones.</p> Source code in <code>backend\\app\\schemas\\user.py</code> <pre><code>class UserType(str, Enum):\n    \"\"\"Tipos de usuario en el sistema.\n\n    Attributes:\n        patient: Usuario paciente que recibe terapia.\n        therapist: Usuario terapeuta que conduce sesiones.\n    \"\"\"\n    patient = \"patient\"\n    therapist = \"therapist\"\n</code></pre>"},{"location":"backend/schemas/#app.schemas.user.UserBase","title":"<code>UserBase</code>","text":"<p>               Bases: <code>BaseModel</code></p> <p>Schema base para usuarios con campos comunes.</p> <p>Attributes:</p> Name Type Description <code>email</code> <code>EmailStr</code> <p>Correo electr\u00f3nico del usuario.</p> <code>full_name</code> <code>str</code> <p>Nombre completo del usuario.</p> Source code in <code>backend\\app\\schemas\\user.py</code> <pre><code>class UserBase(BaseModel):\n    \"\"\"Schema base para usuarios con campos comunes.\n\n    Attributes:\n        email (EmailStr): Correo electr\u00f3nico del usuario.\n        full_name (str): Nombre completo del usuario.\n    \"\"\"\n    email: EmailStr\n    full_name: str\n\n    @field_validator('full_name')\n    @classmethod\n    def full_name_not_empty(cls, v: str):\n        \"\"\"Valida que full_name no est\u00e9 vac\u00edo.\"\"\"\n        if not v or not v.strip():\n            raise ValueError(\"full_name must not be empty\")\n        return v.strip()\n</code></pre>"},{"location":"backend/schemas/#app.schemas.user.UserBase.full_name_not_empty","title":"<code>full_name_not_empty(v)</code>  <code>classmethod</code>","text":"<p>Valida que full_name no est\u00e9 vac\u00edo.</p> Source code in <code>backend\\app\\schemas\\user.py</code> <pre><code>@field_validator('full_name')\n@classmethod\ndef full_name_not_empty(cls, v: str):\n    \"\"\"Valida que full_name no est\u00e9 vac\u00edo.\"\"\"\n    if not v or not v.strip():\n        raise ValueError(\"full_name must not be empty\")\n    return v.strip()\n</code></pre>"},{"location":"backend/schemas/#app.schemas.user.UserCreate","title":"<code>UserCreate</code>","text":"<p>               Bases: <code>UserBase</code></p> <p>Schema para creaci\u00f3n de usuarios.</p> <p>Attributes:</p> Name Type Description <code>password</code> <code>str</code> <p>Contrase\u00f1a en texto plano (se hashear\u00e1).</p> <code>type</code> <code>UserType</code> <p>Tipo de usuario (patient o therapist).</p> Source code in <code>backend\\app\\schemas\\user.py</code> <pre><code>class UserCreate(UserBase):\n    \"\"\"Schema para creaci\u00f3n de usuarios.\n\n    Attributes:\n        password (str): Contrase\u00f1a en texto plano (se hashear\u00e1).\n        type (UserType): Tipo de usuario (patient o therapist).\n    \"\"\"\n    password: str\n    type: UserType\n</code></pre>"},{"location":"backend/schemas/#app.schemas.user.UserLogin","title":"<code>UserLogin</code>","text":"<p>               Bases: <code>BaseModel</code></p> <p>Schema para login de usuarios.</p> <p>Attributes:</p> Name Type Description <code>email</code> <code>EmailStr</code> <p>Correo electr\u00f3nico.</p> <code>password</code> <code>str</code> <p>Contrase\u00f1a en texto plano.</p> Source code in <code>backend\\app\\schemas\\user.py</code> <pre><code>class UserLogin(BaseModel):\n    \"\"\"Schema para login de usuarios.\n\n    Attributes:\n        email (EmailStr): Correo electr\u00f3nico.\n        password (str): Contrase\u00f1a en texto plano.\n    \"\"\"\n    email: EmailStr\n    password: str\n</code></pre>"},{"location":"backend/schemas/#app.schemas.user.User","title":"<code>User</code>","text":"<p>               Bases: <code>UserBase</code></p> <p>Schema de respuesta para usuarios.</p> <p>Attributes:</p> Name Type Description <code>id</code> <code>int</code> <p>ID \u00fanico del usuario.</p> <code>type</code> <code>UserType</code> <p>Tipo de usuario.</p> <code>is_active</code> <code>bool</code> <p>Si la cuenta est\u00e1 activa.</p> <code>created_at</code> <code>datetime</code> <p>Fecha de creaci\u00f3n.</p> Source code in <code>backend\\app\\schemas\\user.py</code> <pre><code>class User(UserBase):\n    \"\"\"Schema de respuesta para usuarios.\n\n    Attributes:\n        id (int): ID \u00fanico del usuario.\n        type (UserType): Tipo de usuario.\n        is_active (bool): Si la cuenta est\u00e1 activa.\n        created_at (datetime): Fecha de creaci\u00f3n.\n    \"\"\"\n    id: int\n    type: UserType\n    is_active: bool\n    created_at: datetime\n    class Config:\n        orm_mode = True\n</code></pre>"},{"location":"backend/schemas/#session-schemas","title":"Session Schemas","text":""},{"location":"backend/schemas/#app.schemas.session","title":"<code>session</code>","text":""},{"location":"backend/schemas/#prompt-schemas","title":"Prompt Schemas","text":""},{"location":"backend/schemas/#app.schemas.prompt","title":"<code>prompt</code>","text":""},{"location":"frontend/componentes/","title":"Componentes Vue","text":"<p>Documentaci\u00f3n de los componentes de Vue.js.</p> <p>En desarrollo...</p>"},{"location":"frontend/services/","title":"Frontend Services","text":"<p>Servicios de comunicaci\u00f3n con la API backend.</p>"},{"location":"frontend/services/#userservice","title":"userService","text":"<ul> <li><code>getUsers()</code>: Obtiene lista de usuarios</li> <li><code>getUserById(userId)</code>: Obtiene usuario por ID</li> <li><code>createUser(userData)</code>: Registra nuevo usuario</li> <li><code>login(credentials)</code>: Login con email/password</li> <li><code>getCurrentUser()</code>: Usuario actual autenticado</li> <li><code>logout()</code>: Cierra sesi\u00f3n</li> </ul>"},{"location":"frontend/services/#sessionsservice","title":"sessionsService","text":"<ul> <li><code>getActiveSession()</code>: Sesi\u00f3n activa del usuario</li> <li><code>getNextSession()</code>: Pr\u00f3xima sesi\u00f3n (activa o futura)</li> <li><code>endSession(sessionId)</code>: Finaliza sesi\u00f3n (terapeuta)</li> <li><code>getSession(sessionId)</code>: Informaci\u00f3n de sesi\u00f3n por ID</li> <li><code>getMySessions()</code>: Todas las sesiones del usuario</li> <li><code>createSession(patientId, sessionData)</code>: Crea sesi\u00f3n (terapeuta)</li> <li><code>deleteSession(sessionId)</code>: Elimina sesi\u00f3n (terapeuta)</li> <li><code>updateSession(sessionId, sessionData)</code>: Actualiza sesi\u00f3n</li> <li><code>getImagesForSession(sessionId)</code>: Im\u00e1genes de sesi\u00f3n</li> </ul>"},{"location":"frontend/services/#comfyservice","title":"comfyService","text":"<ul> <li><code>createImage(prompt, userId, sessionId)</code>: Genera imagen txt2img</li> <li><code>convertirBoceto(prompt, userId, sessionId)</code>: Convierte boceto img2img</li> <li><code>generateImageByMultiple(images, count, userId, sessionId)</code>: Combina m\u00faltiples im\u00e1genes</li> <li><code>uploadImage(file, userId, isDrawnImage)</code>: Sube imagen al servidor</li> <li><code>uploadDrawnImage(file, userId)</code>: Sube dibujo de canvas</li> <li><code>getImagesForUser(userId)</code>: Todas las im\u00e1genes del usuario</li> <li><code>getTemplateImages()</code>: Lista de im\u00e1genes plantilla</li> <li><code>linkImageToSession(imageFileName, userId, sessionId)</code>: Asocia imagen a sesi\u00f3n</li> </ul> <p>Ver JSDoc en archivos fuente para detalles completos de par\u00e1metros y respuestas.</p>"},{"location":"frontend/vistas/","title":"Vistas","text":"<p>Documentaci\u00f3n de las vistas (p\u00e1ginas) de la aplicaci\u00f3n.</p> <p>En desarrollo...</p>"}]}